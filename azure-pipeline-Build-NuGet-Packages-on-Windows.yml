steps:

  - bash: |
      set -eu; set -o pipefail;
      export TARGET_DIR=/usr/bin
      script=https://raw.githubusercontent.com/devizer/test-and-build/master/install-build-tools-bundle.sh; 
      script=https://devizer.github.io/devops-library/Standalone-Bootstrap.sh
      (wget -q -nv --no-check-certificate -O - $script 2>/dev/null || curl -ksSL $script) | bash
      Say --Reset-Stopwatch
      Say "CPU: $(Get-CpuName)"
      echo "try-and-retry: [$(command -v try-and-retry || true)]"
      echo "Wait-For-HTTP: [$(command -v Wait-For-HTTP || true)]"
    condition: succeededOrFailed()
    retryCountOnTaskFailure: 3
    displayName: 'Bootstrap bash'

  - pwsh: |
        $ErrorActionPreference="Continue"
        Import-DevOps
        Say "PATH IS"
        Write-Host (@($ENV:PATH.Split(";")) -join "`n")
        Say "Assigning action ..."
        $action = { Get-ChildItem | Out-Host }
        Say "Assigning action complete. Type is [$($action.GetType())]"
        Try-And-Retry -Title "Acceptance Test: Get-ChildItem" -Action $action
        $true
    displayName: 'TEST PWSH'

  - powershell: |
      iex ((New-Object System.Net.WebClient).DownloadString('https://raw.githubusercontent.com/devizer/Universe.SqlServerJam/master/SqlServer-Version-Management/Install-SqlServer-Version-Management.ps1'))
    retryCountOnTaskFailure: 3
    displayName: "Bootstrap Module"

  - bash: |
      # script=https://raw.githubusercontent.com/devizer/test-and-build/master/install-build-tools-bundle.sh; (wget -q -nv --no-check-certificate -O - $script 2>/dev/null || curl -ksSL $script) | bash >/dev/null
      # Say "CPU: $(Get-CpuName)"
      export SQLINSIGHTS_NUGET_BUILDER_FOLDER='D:\Build'
      cd scripts
      powershell -f Build-NuGET-Array.ps1
      ls -la "$SQLINSIGHTS_NUGET_BUILDER_FOLDER"
      cp -v "$SQLINSIGHTS_NUGET_BUILDER_FOLDER"/*nupkg "$SYSTEM_ARTIFACTSDIRECTORY"
      cp -v "$SQLINSIGHTS_NUGET_BUILDER_FOLDER"/*BUILD-LOG*.7z "$SYSTEM_ARTIFACTSDIRECTORY"
    retryCountOnTaskFailure: 3
    displayName: "BUILD NuGet Array (Windows)"

  - task: PublishBuildArtifacts@1
    condition: succeededOrFailed()
    displayName: 'Publish NuGet Array'
    inputs:
      pathtoPublish: '$(SYSTEM.ARTIFACTSDIRECTORY)'
      artifactName: 'NuGet Array (Built on Windows)'
