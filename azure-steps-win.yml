# AGENT_OS=Linux|Darwin|Windows_NT
# condition: eq(variables['Agent.OS'], 'Linux|Darwin|Windows_NT')

steps:

  - bash: |
      set -eu; set -o pipefail;
      export TARGET_DIR=/usr/bin
      script=https://raw.githubusercontent.com/devizer/test-and-build/master/install-build-tools-bundle.sh; 
      script=https://devizer.github.io/devops-library/Standalone-Bootstrap.sh
      (wget -q -nv --no-check-certificate -O - $script 2>/dev/null || curl -ksSL $script) | bash
      Say --Reset-Stopwatch
      Say "CPU: $(Get-CpuName)"
      echo "try-and-retry: [$(command -v try-and-retry || true)]"
      echo "Wait-For-HTTP: [$(command -v Wait-For-HTTP || true)]"
    condition: succeededOrFailed()
    retryCountOnTaskFailure: 3
    displayName: 'Bootstrap bash'

  - pwsh: |
        $ErrorActionPreference="Continue"
        Import-DevOps
        Say "PATH IS"
        Write-Host (@($ENV:PATH.Split(";") | Sort-Object) -join "`n`r")
        Try-And-Retry -Title "Acceptance Test: Get-ChildItem" -Action ([scriptblock]{ Get-ChildItem | Out-Host })
        Try-And-Retry -Title "Acceptance Test: docker ps" -Action ([scriptblock]{ & docker.exe ps | Out-Host })
        $true
    displayName: 'TEST PWSH'
     
  
  - bash: |
       set -eu; set -o pipefail
       if [[ "$SQL" == 2005* || "$SQL" == 2008* ]]; then NEED_CONTAINER=True; SQL_IMAGE_TAG=ltsc2022;
       elif [[ "$SQL" == "HOST FOR 2012"* ]]; then NEED_CONTAINER=True; SQL_IMAGE_TAG=ltsc2016;
       else NEED_CONTAINER=False; SQL_IMAGE_TAG=""; fi
       echo "##vso[task.setvariable variable=NEED_CONTAINER;isOutput=true]$NEED_CONTAINER"
       echo "##vso[task.setvariable variable=SQL_IMAGE_TAG]$SQL_IMAGE_TAG"
       Say "NEED_CONTAINER = [$NEED_CONTAINER] (for conditions)"
       Say "SQL_IMAGE_TAG = [$SQL_IMAGE_TAG] (for environment variables)"
       # condition: eq(variables['Setup.NEED_CONTAINER'], 'True')
       # condition: or(failed(), eq(variables['Setup.NEED_CONTAINER'], 'True'))

       echo
       SQLSERVERS_SETUP_FOLDER='C:\SQL-Setup\Installer'
       SQLSERVERS_MEDIA_FOLDER='C:\SQL-Setup\Media'
       [[ -d 'D:\' ]] && SQLSERVERS_SETUP_FOLDER='C:\SQL-Setup\Installer'
       Say "SQLSERVERS_MEDIA_FOLDER (download) = '$SQLSERVERS_MEDIA_FOLDER'"
       Say "SQLSERVERS_SETUP_FOLDER (installer) = '$SQLSERVERS_SETUP_FOLDER'"
       echo "##vso[task.setvariable variable=SQLSERVERS_MEDIA_FOLDER]$SQLSERVERS_MEDIA_FOLDER"
       echo "##vso[task.setvariable variable=SQLSERVERS_SETUP_FOLDER]$SQLSERVERS_SETUP_FOLDER"
       echo "##vso[task.setvariable variable=PS1_TROUBLE_SHOOT]On"

    name: Setup
    displayName: 'Setup pipeline'

  - bash: |
      Run-Remote-Script https://raw.githubusercontent.com/devizer/glist/master/Move-Docker-to-SSD-for-Windows-On-Microsoft-Hosted-Build-Agent.ps1
    displayName: 'Tune Docker Storage'

  - bash: |
      try-and-retry docker pull mcr.microsoft.com/windows/nanoserver:ltsc2022
    displayName: 'Pull nano server'
  
  - bash: |
      docker run --rm --isolation=process mcr.microsoft.com/windows/nanoserver:ltsc2022 cmd //c ver
      true
    retryCountOnTaskFailure: 3
    displayName: 'Test Docker process'

  - bash: |
      docker run --rm --isolation=hyperv mcr.microsoft.com/windows/nanoserver:ltsc2022 cmd //c ver
      true
    retryCountOnTaskFailure: 3
    displayName: 'Test Docker hyperv'

  - powershell: |
      Say "CPU: $(Get-Cpu-Name -IncludeCoreCount). $((Get-Memory-Info).Description)"
      (Get-Module SqlServer-Version-Management -ListAvailable) | fl

      # Measure-Action "Uninstall LocalDB *" { Uninstall-LocalDB-List "*" }
    retryCountOnTaskFailure: 3
    displayName: 'Bootstrap pwsh'

  

  - task: DownloadPipelineArtifact@2
    condition: succeededOrFailed()
    displayName: 'Goods: download (w3api, w3api.tests, jam.tests)'
    inputs:
      artifactName: Goods
      path: $(AGENT.TEMPDIRECTORY)\Goods
      patterns: 
        "**"
   
  - bash: |
       cd "$AGENT_TEMPDIRECTORY"
       cd Goods
       ls -la
    displayName: 'Show Goods: w3api, w3api.tests, jam.tests'


  - powershell: |
      $ErrorActionPreference="Continue"
      scripts\Enumerate-NanoServer-Tags.ps1
      $true
    condition: eq(variables['SYSTEM.JOBDISPLAYNAME'], 'If SQL Server 2016')
    displayName: 'Enumerate NanoServer Tags'

  - bash: |
     script=https://raw.githubusercontent.com/devizer/test-and-build/master/install-build-tools-bundle.sh; (wget -q -nv --no-check-certificate -O - $script 2>/dev/null || curl -ksSL $script) | bash >/dev/null
     for v in 5.0 6.0 7.0 8.0; do
       Say "ASP.NET $v"
       echo mcr.microsoft.com/dotnet/aspnet:$v >> "$SYSTEM_ARTIFACTSDIRECTORY/ASP.NET Docker Images.txt"
       try-and-retry docker manifest inspect mcr.microsoft.com/dotnet/aspnet:$v |& tee -a "$SYSTEM_ARTIFACTSDIRECTORY/ASP.NET docker images.txt"
     done 

     # Missing: 1703, 21H1 21H2 21H2 22H2
     for v in 1709 1803 1809 1903 1909 2004 2009 20H2 ltsc2022 ltsc2019; do
       Say "NANO SERVER $v"
       echo mcr.microsoft.com/windows/nanoserver:$v >> "$SYSTEM_ARTIFACTSDIRECTORY/NANO SERVER docker imaged.txt"
       try-and-retry docker manifest inspect mcr.microsoft.com/windows/nanoserver:$v |& tee -a "$SYSTEM_ARTIFACTSDIRECTORY/NANO SERVER docker imaged.txt"
     done 

     true
    condition: eq(variables['SYSTEM.JOBDISPLAYNAME'], 'If SQL Server 2016')
    displayName: "Docker ispect images"

  - powershell: |
      (Get-Counter -ListSet *).Paths | Where-Object { $_ -like "*Transfers*" }
    retryCountOnTaskFailure: 3
    displayName: 'List Perfmormance Counters'

  - powershell: |
      Get-Counter -Counter "\PhysicalDisk(_total)\Disk Transfers/sec" -SampleInterval 1 -MaxSamples 7
      $true
    retryCountOnTaskFailure: 3
    displayName: 'Show Transfer for 20 seconds'

  - powershell: 'Set-NetFirewallProfile -All -Enabled False; netsh advfirewall set currentprofile state off; "ok?";'
    displayName: "Disable firefall"

  - bash: |
      powershell -f scripts/Uninstall-Stuff.ps1 || true
    condition: ne(variables['UNINSTALL_TRASH'], '')
    displayName: 'UNINSTALL TRASH'


  - bash: |
      powershell -f scripts/Create-Windows-Ram-Disk.ps1 || true
    condition: ne(variables['RAM_DISK'], '')
    displayName: 'RAM Disk'

  - powershell: |
       $ErrorActionPreference = "SilentlyContinue"
       
       $nuget = nuget help | select -First 1
       Write-Host "NUGET: $nuget"
       $msbuild = msbuild help | select -First 1
       Write-Host "MSBUILD: $msbuild"

       & dotnet --info
       "PATH: [" + [Environment]::GetEnvironmentVariable("PATH") + "]"
       & bash -c "Say ENVIRONMENT; printenv | sort"; $true

       pushd "C:\Program Files (x86)\Microsoft Visual Studio\"
       # & cmd /c dir /b /s
       popd
    displayName: 'system info (pwsh)'

  - task: DownloadPipelineArtifact@2
    condition: succeededOrFailed()
    displayName: 'w3app: download'
    inputs:
      artifactName: w3app
      path: $(Build.SourcesDirectory)/src/universe.sqlinsights.w3app/build
      patterns: 
        "**"

  - pwsh: |
        Say "Copying Goods ..."
        Copy-Item -Path "$($env:AGENT_TEMPDIRECTORY)\Goods" -Destination "." -Recurse -Force
        Say "'.\Goods' Content"
        Get-ChildItem '.\Goods' | Format-Table -AutoSize | Out-Host
        
        Say "Copying w3app"
        New-Item -ItemType Directory -Force -Path ".\Goods\w3api\wwwroot"
        Copy-Item -Path "$(Build.SourcesDirectory)/src/universe.sqlinsights.w3app/build/*" -Destination ".\Goods\w3api\wwwroot" -Recurse -Force
        
        Say "'.\Goods\w3api\wwwroot' Content"
        Get-ChildItem ".\Goods\w3api\wwwroot" | Format-Table -AutoSize | Out-Host

    displayName: 'Copy Goods'

  - pwsh: |
        Import-DevOps
        $ErrorActionPreference="Continue"
        echo "SQL: '$($ENV:sql)'"

        $image="devizervlad/iis-net4x-net35:$($ENV:SQL_IMAGE_TAG)"
        Say "Pull $image ..."
        Try-And-Retry "PULL $image" "& docker pull $image | out-host"
        & docker pull "$image"

        Say "Starting container sql-server"
        New-item C:\SQL -ItemType Directory -Force -EA SilentlyContinue | Out-Null
        New-item C:\Temp -ItemType Directory -Force -EA SilentlyContinue | Out-Null
        $mnt="type=bind,source=$(Get-Location),target=C:\App"
        echo "--mount parameter is: [$mnt]"
        echo "SYSTEM_ARTIFACTSDIRECTORY = [$($ENV:SYSTEM_ARTIFACTSDIRECTORY)]"
        $cpuCount="$([Environment]::ProcessorCount)"
        # disk D in missing in container
        # --mount "type=bind,source=$($ENV:SYSTEM_ARTIFACTSDIRECTORY),target=$($ENV:SYSTEM_ARTIFACTSDIRECTORY)" `
        # bad: --mount "type=bind,source=C:\SQL,target=C:\SQL" `
        & docker run -d --name sql-server --memory 3300M --cpus "$cpuCount" "--isolation=hyperv" `
          -e SQL="$($ENV:sql)" `
          -e TF_BUILD=True `
          -e SQL_IMAGE_TAG="$($ENV:SQL_IMAGE_TAG)" `
          -e SYSTEM_ARTIFACTSDIRECTORY="$($ENV:SYSTEM_ARTIFACTSDIRECTORY)" `
          -e SYSTEM_ARTIFACTSDIRECTORY="C:\ARTIFACTS" `
          --mount "type=bind,source=$($ENV:SYSTEM_ARTIFACTSDIRECTORY),target=C:\ARTIFACTS" `
          --mount "$mnt" `
          --mount "type=bind,source=C:\Temp,target=C:\Temp" `
          -e PS1_TROUBLE_SHOOT="On" -e SQLSERVERS_SETUP_FOLDER="C:\SQL-Setup" `
          -p 1433:1433 -p 1434:1434 --workdir=C:\App --entrypoint powershell $image -Command "Write-Host WAITING; Sleep 214748; Wait-Event;"
        Sleep 2
        Say "CONTAINER STARTUP LOGS"
        docker logs --since 0 sql-server
        Say "Starting Setup in Container"
        & docker exec sql-server powershell -Command "cd C:\App; ls;" |
          tee-object "$ENV:SYSTEM_ARTIFACTSDIRECTORY/OUTPUT from CONTAINER.txt"

    condition: or(failed(), eq(variables['Setup.NEED_CONTAINER'], 'True'))
    retryCountOnTaskFailure: 3
    displayName: 'Setup Container (sql-server)'

  - powershell: scripts\CI-Steps\Run-CI-Script.ps1 1-Install-Module.ps1
    condition: succeededOrFailed()
    displayName: '1-Install-Module.ps1'

  - powershell: scripts\CI-Steps\Run-CI-Script.ps1 2-Install-DotNet.ps1
    condition: succeededOrFailed()
    displayName: '2-Install-DotNet.ps1'

    # "Password=``1qazxsw2"
  - powershell: scripts\CI-Steps\Run-CI-Script.ps1 3-Install-SQL-Server.ps1
    condition: succeededOrFailed()
    displayName: '3-Install-SQL-Server.ps1'

  - powershell: scripts\CI-Steps\Run-CI-Script.ps1 3.1-Install-SQLCMD.ps1
    condition: succeededOrFailed()
    displayName: '3.1-Install-SQLCMD.ps1'

  - powershell: scripts\CI-Steps\Run-CI-Script.ps1 4-Publish-Sql-Server-Setup-Logs.ps1
    condition: succeededOrFailed()
    displayName: '4-Publish-Sql-Server-Setup-Logs.ps1'

  - powershell: scripts\CI-Steps\Run-CI-Script.ps1 5-Configure-SQL-Server.ps1
    condition: succeededOrFailed()
    displayName: '5-Configure-SQL-Server.ps1'

  - powershell: scripts\CI-Steps\Run-CI-Script.ps1 6-ErgoFab-Tests.ps1
    condition: succeededOrFailed()
    displayName: '6-ErgoFab-Tests.ps1'

  - powershell: scripts\CI-Steps\Run-CI-Script.ps1 7-SqlJam-Tests.ps1
    condition: succeededOrFailed()
    displayName: '7-SqlJam-Tests.ps1'

  - powershell: scripts\CI-Steps\Run-CI-Script.ps1 8-Install-Chrome.ps1
    condition: succeededOrFailed()
    displayName: '8-Install-Chrome.ps1'

  
  - powershell: scripts\CI-Steps\Run-CI-Script.ps1 9-Run-w3app.ps1
    condition: succeededOrFailed()
    # condition: false
    displayName: '9-Run-w3app.ps1'

    


  - powershell: |
      Get-Counter -Counter "\PhysicalDisk(_total)\Disk Transfers/sec" -SampleInterval 1 -MaxSamples 7
      $true
    retryCountOnTaskFailure: 3
    displayName: 'Show Transfer for 20 seconds'

  - script: |
       sqlcmd /? | find "Version"
       for %%a IN ("." "localhost,1433") DO (
        echo "TRY SERVER [%%a]"
        sqlcmd -S %%a -h-1 -s"," -E -W -w 10000 -Q "SELECT Name, Description FROM fn_helpcollations() order by 1" > %SYSTEM_ARTIFACTSDIRECTORY%\fn_helpcollations.txt
        sqlcmd -S %%a -h-1 -s"," -E -W -w 10000 -Q "SET NOCOUNT ON; SELECT DATALENGTH(@@DBTS) as MYDBTS_LENGTH, @@DBTS as MYDBTS;"
        sqlcmd -S %%a -h-1 -s"," -E -W -w 10000 -Q "SET NOCOUNT ON; Select CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion'))"
        sqlcmd -S %%a -h-1 -s"," -E -W -w 10000 -Q "SET NOCOUNT ON; Select @@Version"
        echo. && echo "CHECK Update ... Output"
        sqlcmd -S %%a -E -Q "Create Table Temp1(id int, rv ROWVERSION); Insert Into Temp1(id) Values(10); Update Top (1) Temp1 Set id=42 Output Inserted.Id as MyNewId;"
        echo. && echo "fn_helpcollations"
        sqlcmd -S %%a -h-1 -s"," -E -W -w 10000 -Q "SELECT Name, Description FROM fn_helpcollations() order by 1"
        echo.
       )
       REM true
    condition: eq(variables['Setup.NEED_CONTAINER'], 'False')
    displayName: 'Show SQL Info'
  
  - task: PublishBuildArtifacts@1
    condition: succeededOrFailed()
    displayName: 'Publish SQL Setup Logs'
    inputs:
      pathtoPublish: '$(SYSTEM.ARTIFACTSDIRECTORY)'
      artifactName: 'SQL Setup Logs $(Agent.JobName)'

  - bash: |
      set -eu
      cd src/universe.sqlinsights.w3app
      cd build
      echo "SERVING STATIC W3APP. Folder '$(pwd -P)', Content of ./static/js:"
      ls -la static/js
      echo "INDEX.HTML"
      cat index.html
      dotnet serve --version 2>nul || dotnet tool install --global dotnet-serve
      dotnet serve --version
      start /max dotnet serve -p 6060 -o
    # condition: always()
    condition: false
    displayName: 'w3app: run'

  - bash: |
      set -eu
      Say "dotnet-serve processes"
      powershell -c "Get-Process -Name 'dotnet-serve' | format-table -autosize | out-host" || true
      sleep 3
      echo "Wait for STATUS (http://localhost:6060)"
      Wait-For-HTTP http://localhost:6060 || true
      echo HEADERS
      curl -I http://localhost:6060
    condition: eq(variables['Agent.OS'], 'Windows_NT')
    displayName: 'w3app: monitor'



  - script: |
      call 0a-Net-Restore-All.cmd
    # condition: eq(variables['Agent.OS'], 'Windows_NT')
    condition: ${{ false }}
    displayName: 'dotnet restore'

  - powershell: |
      Get-Counter -Counter "\PhysicalDisk(_total)\Disk Transfers/sec" -SampleInterval 1 -MaxSamples 7
      $true
    displayName: 'Show Transfer for 20 seconds'

  - bash: |
      set -eu; set -o pipefail;
      if [[ "${RAM_DISK:-}" == "" ]]; then export NUNIT_PIPELINE_KEEP_TEMP_TEST_DATABASES=True; fi # for query cache
      export SQLINSIGHTS_DATA_DIR=D:\\SQL-Data
      export TEST_CPU_NAME="$(Get-CpuName --name-only)"
      export TEST_CONFIGURATION="DISK";
      if [[ -n "${DB_DATA_DIR:-}" ]]; then
        export SQLINSIGHTS_DATA_DIR="$DB_DATA_DIR"
        export TEST_CONFIGURATION="RAM-Disk"
        Say "SQLINSIGHTS_DATA_DIR is $SQLINSIGHTS_DATA_DIR"
      fi
      cd $AGENT_TEMPDIRECTORY/Goods/w3api.tests
      export TEST_UNDER_COVERAGE=True
      dotnet test --collect:"XPlat Code Coverage" --logger trx Universe.SqlInsights.SqlServerStorage.Tests.dll

      Say "Benchmark Seed"
      rm -f $SYSTEM_ARTIFACTSDIRECTORY/AddAction.log
      export TEST_UNDER_COVERAGE=False
      dotnet test --filter "Name~Test1_Seed" Universe.SqlInsights.SqlServerStorage.Tests.dll
    # condition: eq(variables['Agent.OS'], 'Windows_NT')
    condition: eq(variables['Setup.NEED_CONTAINER'], 'False')
    displayName: 'TEST STORAGE +BENCHMARK'

  - script: |
      dir %DB_DATA_DIR%
      echo.
    condition: ne(variables['DB_DATA_DIR'], '')
    displayName: 'RAM Disk Usage'

  - powershell: |
      Get-Counter -Counter "\PhysicalDisk(_total)\Disk Transfers/sec" -SampleInterval 1 -MaxSamples 7
      $true
    displayName: 'Show Transfer for 7 seconds'

  - bash: |
      # was Content root path: "D:\\a\\_temp\\Goods\\w3api"
      # now Content root path: "D:\\a\\_temp\\Goods\\w3api"

      echo Starting W3Api
      export SQLINSIGHTS_REPORT_FOLDER="C:\\Temp\\SqlInsights-W3Api-Internal-Logs"
      export SQLINSIGHTS_REPORT_FULLNAME="${SQLINSIGHTS_REPORT_FOLDER}\\Report.Txt"
      export ASPNETCORE_URLS=http://localhost:50420
      pushd $AGENT_TEMPDIRECTORY/Goods/w3api;
      if [[ -s ~/w3api.pid ]]; then 
        pid=$(<~/w3api.pid) 
        echo KILL W3API Process $pid
        kill $pid
      fi
      echo Starting W3Api, folder is $(pwd -P)
      (dotnet Universe.SqlInsights.W3Api.dll | tee "$SYSTEM_ARTIFACTSDIRECTORY/w3api (acceptance test).log") &
      echo $! > ~/w3api.pid
      popd
      sleep 60
      
      source scripts/wait_for_http.sh
      WAIT_HTTP_TIMEOUT=90
      Say "Waiting for swagger ...."
      wait_for_http "http://localhost:50420/swagger"
      
      # for acceptance test?
      # sleep 60

      set -o pipefail
      Say "Final Test: get swagger"
      curl -I http://localhost:50420/swagger | cat || exit 666;
      Say "KILL W3API and W3APP"
      echo Kill dotnet-serve.exe
      taskkill.exe -F -T -IM dotnet-serve.exe
      echo Kill dotnet.exe
      taskkill.exe -F -T -IM dotnet.exe
      7z a "${SYSTEM_ARTIFACTSDIRECTORY}\\SqlInsights Report.7z" "${SQLINSIGHTS_REPORT_FOLDER}"
      (echo "CPU: $(Get-CpuName)"; echo "Job: ${AGENT_JOBNAME}"; cat "${SQLINSIGHTS_REPORT_FULLNAME}") > /tmp/report; cp -f /tmp/report "${SQLINSIGHTS_REPORT_FULLNAME}"
      cp -f "${SQLINSIGHTS_REPORT_FULLNAME}" "${SYSTEM_ARTIFACTSDIRECTORY}\\SqlInsights Report.txt"
      true
    condition: eq(variables['TEST_W3API'], 'true')
    retryCountOnTaskFailure: 3
    timeoutInMinutes: 10
    displayName: 'RUN W3API (optional)'


  - bash: |
      set -eu; set -o pipefail;
      cd scripts
      powershell -f Stress-SQL-Server-by-Stored-Procedure.ps1 
    condition: eq(variables['Setup.NEED_CONTAINER'], 'False')
    displayName: 'STRESS SQL via Stor Proc'

  - bash: |
      set -eu; set -o pipefail;
      export SQL_ADMINISTRATIVE_VIEWS_SUMMARY_1_Cpu_Title="CPU"
      export SQL_ADMINISTRATIVE_VIEWS_SUMMARY_1_Cpu_Kind="String"
      export SQL_ADMINISTRATIVE_VIEWS_SUMMARY_1_Cpu_Value="$(Get-CpuName --name-only)"
      export SQL_ADMINISTRATIVE_VIEWS_SUMMARY_1_Cpu_Position=Header
      if [[ -n "${DB_DATA_DIR:-}" ]] then
        export SQL_ADMINISTRATIVE_VIEWS_SUMMARY_RAM_Disk_Title="Data RAM Disk (MB)"
        export SQL_ADMINISTRATIVE_VIEWS_SUMMARY_RAM_Disk_Kind="Natural"
        export SQL_ADMINISTRATIVE_VIEWS_SUMMARY_RAM_Disk_Value="${RAM_DISK_SIZE:-}"
        export SQL_ADMINISTRATIVE_VIEWS_SUMMARY_RAM_Disk_Position=9999
      fi
      dotnet tool install --global SqlServer.AdministrativeViews
      SqlServer.AdministrativeViews -all -o "C:\\Administrative Views\\{InstanceName} {Version} on {Platform}"
      ls -la "/c/Administrative Views" || true
      Say "Success Complete"
    condition: succeededOrFailed()
    displayName: 'TEST Administrative Views by Tool'

  - bash: |
      set -eu; set -o pipefail;
      export SQL_ADMINISTRATIVE_VIEWS_SUMMARY_1_Cpu_Title="CPU"
      export SQL_ADMINISTRATIVE_VIEWS_SUMMARY_1_Cpu_Kind="String"
      export SQL_ADMINISTRATIVE_VIEWS_SUMMARY_1_Cpu_Value="$(Get-CpuName --name-only)"
      export SQL_ADMINISTRATIVE_VIEWS_SUMMARY_1_Cpu_Position=Header
      if [[ -n "${DB_DATA_DIR:-}" ]] then
        export SQL_ADMINISTRATIVE_VIEWS_SUMMARY_RAM_Disk_Title="Data RAM Disk (MB)"
        export SQL_ADMINISTRATIVE_VIEWS_SUMMARY_RAM_Disk_Kind="Natural"
        export SQL_ADMINISTRATIVE_VIEWS_SUMMARY_RAM_Disk_Value="${RAM_DISK_SIZE:-}"
        export SQL_ADMINISTRATIVE_VIEWS_SUMMARY_RAM_Disk_Position=9999
      fi
      cd $AGENT_TEMPDIRECTORY/Goods/AdministrativeViews.tests
      dotnet test Universe.SqlServer.AdministrativeViews.Tests.dll
      du -h "${SYSTEM_ARTIFACTSDIRECTORY}" || true
      # cp -a -v TestResults "${SYSTEM_ARTIFACTSDIRECTORY}"
      Say "Success Complete"
    condition: succeededOrFailed()
    displayName: 'TEST Administrative Views by Source'

  - task: PublishBuildArtifacts@1
    condition: succeededOrFailed()
    displayName: 'Publish Administrative Views Report'
    inputs:
      pathtoPublish: '$(SYSTEM.ARTIFACTSDIRECTORY)\\AdministrativeViews'
      artifactName: 'Administrative Views Reports $(Agent.JobName) $(Build.BUILDNUMBER)'


  # TODO: SHOULD BE OPTIONAL via Variable
  # Do not feed Query Cache Report
  - bash: |
      set -eu; set -o pipefail;
      Say "CPU: $(Get-CpuName)"
      printenv | { grep ERGOFAB || true; }

      cd src/ErgoFab.DataAccess.IntegrationTests
      bash -e -u Test-via-NuGET.sh
      Say "Success Complete"
    # New Sql Versions should support ERGOFAB TESTS
    condition: and(ne(variables['SKIP_ERGOFAB_TESTS'], 'True'), eq(variables['Setup.NEED_CONTAINER'], 'False'))
    displayName: '2ND TEST ErgoFab (SQL) via NuGet'

  - task: PublishTestResults@2
    condition: succeededOrFailed()
    inputs:
      testRunner: VSTest
      testResultsFiles: '**/*.trx'
      testRunTitle: 'All the tests for $(Agent.JobName)'
      
  - task: PublishCodeCoverageResults@1
    condition: succeededOrFailed()
    inputs:
      codeCoverageTool: cobertura
      failIfCoverageEmpty: false # Optional      
      summaryFileLocation: '**/In/**/coverage.cobertura.xml'

  - publish: $(SYSTEM.ARTIFACTSDIRECTORY)
    displayName: 'Publish Artifact'
    # condition: succeededOrFailed()
    artifact: 'Artifacts $(Agent.JobName)'
