variables:
  Project: 'Universe.SqlInsights'
  TEST_W3API: true
  # Default image
  VMIMAGE: 'windows-2019'
  DEFAULT_RAM_DISK_SIZE: "1200"
  W3API_NET: net5.0

jobs:

  - job: Build_W3_App_Docker_Image
    displayName: 'W3App Docker Image and GitHub Release'
    pool:
      vmImage: "ubuntu-20.04"
    steps:
      - bash: |
         script=https://raw.githubusercontent.com/devizer/test-and-build/master/install-build-tools-bundle.sh; (wget -q -nv --no-check-certificate -O - $script 2>/dev/null || curl -ksSL $script) | bash >/dev/null
         Say --Reset-Stopwatch; Say "CPU: $(Get-CpuName)"
         docker login -u devizervlad -p "$PASSWORD"
         printenv | sort
         
         pushd scripts/Linux-W3App-Docker
         bash -e Build-W3App-Linux-Docker-Image.sh
         popd
        displayName: 'Build w3app Docker Image'
        env:
            PASSWORD: $(DOCKER_PASSWORD)

      - bash: |
         set -eu; set -o pipefail
         Say --Reset-Stopwatch; Say "CPU: $(Get-CpuName)"
         echo $PASSWORD | gh auth login --with-token
         source scripts/Build-Github-Release-Artifacts.sh

         Say "Building W3API docker images in [$(pwd)]"
         Say "SQLINSIGHTS_VERSION: [$SQLINSIGHTS_VERSION]"
         
         pushd scripts/Linux-W3API-Docker-FXDependent
         source Build-W3App-Linux-Docker-Image.sh
         popd

         pushd scripts/Linux-W3API-Docker
         source Build-W3API-Linux-Docker-Image.sh
         popd


        displayName: 'GitHub Release'
        env:
            PASSWORD: $(GITHUB_TOKEN)

      - publish: $(Build.SourcesDirectory)/src/universe.sqlinsights.w3app/build
        displayName: 'Publish Artifact'
        condition: succeededOrFailed()
        artifact: 'w3app'
    
      - publish: $(SYSTEM.ARTIFACTSDIRECTORY)
        displayName: 'Publish Artifact'
        condition: succeededOrFailed()
        artifact: '$(Agent.JobName)'
    

trigger:
  batch: false
  branches:
    include:
    - main
  paths:
    exclude:
    - '**'
    include:
    - 'azure-pipelines-W3App-Docker-Image.yml'
    - 'scripts/Linux-W3App-Docker/**'
    - 'scripts/Build-Github-Release-Artifacts.sh'
    - 'scripts/Linux-W3API-Docker/**'
